<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAPPORT TECHNIQUE | VAL-DE-MARNE</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- CHARTE GRAPHIQUE VAL-DE-MARNE --- */
        :root { 
            --blue-vdm: #004481; /* Bleu Institutionnel */
            --gold-vdm: #cfa052; /* Dor√© Prestige */
            --grey-bg: #eef2f5;
            --text-dark: #2c3e50;
        }

        /* RESET ET STRUCTURE */
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            background: var(--grey-bg); 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* --- EN-T√äTE PROFESSIONNEL --- */
        header { 
            background: white; 
            height: 80px; 
            padding: 0 30px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 4px solid var(--blue-vdm);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
            z-index: 100;
        }

        /* LOGO ET TITRE */
        .brand { display: flex; align-items: center; gap: 20px; }
        .logo-img { height: 60px; width: auto; } /* Logo VDM */
        .app-title { 
            font-size: 20px; font-weight: 700; color: var(--blue-vdm); 
            text-transform: uppercase; letter-spacing: 0.5px;
            border-left: 2px solid #ddd; padding-left: 20px;
        }

        /* BOUTONS D'ACTION */
        .actions { display: flex; gap: 15px; }
        .btn { 
            padding: 12px 25px; border: none; border-radius: 6px; 
            font-weight: 600; cursor: pointer; font-size: 15px; 
            transition: all 0.2s; display: flex; align-items: center; gap: 10px;
        }
        .btn-import { background: var(--blue-vdm); color: white; }
        .btn-import:hover { background: #003366; }
        .btn-save { background: #27ae60; color: white; }
        .btn-save:hover { background: #219150; }

        /* --- INTERFACE PRINCIPALE --- */
        #workspace { display: flex; flex: 1; overflow: hidden; }

        /* SIDEBAR (LISTE DES BATIMENTS) */
        #sidebar { 
            width: 280px; background: white; 
            border-right: 1px solid #ddd; 
            display: flex; flex-direction: column;
            flex-shrink: 0;
        }
        .sidebar-header {
            padding: 20px; background: var(--blue-vdm); color: white;
            font-weight: bold; text-align: center; font-size: 14px;
        }
        #bat-list { overflow-y: auto; flex: 1; }
        .bat-item { 
            padding: 18px 20px; border-bottom: 1px solid #f0f0f0; 
            cursor: pointer; color: var(--text-dark); font-size: 15px; font-weight: 500;
            transition: background 0.2s;
        }
        .bat-item:hover { background: #f8f9fa; color: var(--blue-vdm); }
        .bat-item.active { 
            background: var(--blue-vdm); color: white; 
            border-left: 5px solid var(--gold-vdm);
        }

        /* ZONE DE CONTENU (SCROLLABLE) */
        #viewer { 
            flex: 1; overflow-y: auto; padding: 40px; 
            display: flex; flex-direction: column; align-items: center; 
            scroll-behavior: smooth;
        }

        /* --- LA CASE UNIVERSELLE (MISE EN PAGE FIG√âE) --- */
        .card {
            display: flex; 
            flex-direction: row; /* Toujours c√¥te √† c√¥te */
            width: 100%; max-width: 1500px; /* Largeur max */
            height: 550px; /* HAUTEUR FIXE : Rien ne bouge */
            background: white; 
            margin-bottom: 40px; 
            border: 1px solid #dcdcdc; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-radius: 8px; overflow: hidden;
        }

        /* GAUCHE : IMAGE (50%) */
        .card-img {
            width: 50%; height: 100%;
            background: #050a14; /* Fond presque noir */
            display: flex; align-items: center; justify-content: center;
            border-right: 4px solid var(--gold-vdm);
        }
        .card-img img {
            max-width: 100%; max-height: 100%; 
            object-fit: contain; /* L'image s'adapte sans d√©former */
        }

        /* DROITE : TEXTE (50%) */
        .card-txt {
            width: 50%; height: 100%;
            padding: 35px;
            font-size: 20px; /* Gros caract√®res pour lisibilit√© */
            line-height: 1.6;
            color: #333;
            background: white;
            overflow-y: auto; /* Scroll interne si le texte d√©passe */
            font-family: 'Segoe UI', sans-serif;
        }
        .card-txt:focus { background: #fffdf5; outline: none; } /* Focus jaune p√¢le */
        
        /* FORMAT TITRE BATIMENT */
        .bat-title {
            width: 100%; max-width: 1500px;
            color: var(--blue-vdm);
            border-bottom: 3px solid var(--gold-vdm);
            padding-bottom: 15px; margin-bottom: 30px;
            font-size: 28px; font-weight: 700;
        }
    </style>
</head>
<body>

<input type="file" id="fileInput" style="display:none" onchange="importerFichier(this)">

<header>
    <div class="brand">
        <img src="https://upload.wikimedia.org/wikipedia/fr/thumb/3/30/Logo_Val_de_Marne.svg.png/1200px-Logo_Val_de_Marne.svg.png" class="logo-img" alt="Logo Val-de-Marne">
        <div class="app-title">Studio Technique<br><span style="font-size:14px; color:#666;">PLAN PLURIANNUEL D'INVESTISSEMENT</span></div>
    </div>
    <div class="actions">
        <button class="btn btn-import" onclick="document.getElementById('fileInput').click()">üìÇ IMPORTER MON FICHIER</button>
        <button class="btn btn-save" onclick="sauvegarder()">üíæ T√âL√âCHARGER LE RAPPORT</button>
    </div>
</header>

<div id="workspace">
    <div id="sidebar">
        <div class="sidebar-header">B√ÇTIMENTS / ZONES</div>
        <div id="bat-list"></div>
    </div>
    <div id="viewer">
        </div>
</div>

<script>
    // --- 1. SIMULATION PAR D√âFAUT (Pour montrer que √ßa marche) ---
    let DATA = {};

    function initSimulation() {
        // G√©n√©ration de 15 B√¢timents avec 12 photos chacun = ~180 photos
        const textLorem = "Observation : D√©gradation avanc√©e des enduits de fa√ßade sur la zone Nord.\n\nPr√©conisation : \n1. Purge des parties non adh√©rentes.\n2. Application d'un fixateur de fond.\n3. Reprise des ma√ßonneries et mise en peinture classe D3.\n\nNote : L'accessibilit√© n√©cessite une nacelle de 16m.\nPriorit√© : Haute (Risque de chute de mat√©riaux).";
        
        for (let i = 1; i <= 15; i++) {
            let nom = `B√¢timent ${String.fromCharCode(64+i)} - √âcole Joliot Curie`;
            let photos = [];
            for (let j = 1; j <= 12; j++) {
                photos.push({
                    src: `https://via.placeholder.com/800x600/004481/FFFFFF?text=PHOTO+${j}+-+BAT+${String.fromCharCode(64+i)}`,
                    txt: `PHOTO N¬∞${j} - ${nom}\n\n${textLorem}`
                });
            }
            DATA[nom] = photos;
        }
        renderSidebar();
    }

    // --- 2. FONCTIONS D'AFFICHAGE (Moteur V9.2) ---
    function renderSidebar() {
        const list = document.getElementById('bat-list');
        list.innerHTML = '';
        const bats = Object.keys(DATA);
        
        bats.forEach((bat, idx) => {
            const div = document.createElement('div');
            div.className = 'bat-item';
            div.innerText = `üè¢ ${bat} (${DATA[bat].length})`;
            div.onclick = () => {
                document.querySelectorAll('.bat-item').forEach(b => b.classList.remove('active'));
                div.classList.add('active');
                renderPhotos(bat);
            };
            list.appendChild(div);
            if(idx === 0) div.click();
        });
    }

    function renderPhotos(batName) {
        const viewer = document.getElementById('viewer');
        viewer.innerHTML = `<h2 class="bat-title">${batName}</h2>`;
        
        DATA[batName].forEach(photo => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-img">
                    <img src="${photo.src}" loading="lazy">
                </div>
                <div class="card-txt" contenteditable="true">
                    ${photo.txt}
                </div>
            `;
            // Sauvegarde automatique des modifications
            card.querySelector('.card-txt').addEventListener('input', (e) => {
                photo.txt = e.target.innerText;
            });
            viewer.appendChild(card);
        });
    }

    // --- 3. FONCTION D'IMPORTATION (R√©paration du fichier cass√©) ---
    function importerFichier(input) {
        if (input.files.length === 0) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            // Regex puissante pour trouver le JSON m√™me dans un fichier HTML cass√©
            const match = content.match(/\{"[\s\S]*"\}/g);
            
            if (match) {
                try {
                    // On prend le plus long bloc JSON trouv√©
                    const cleanJson = match.sort((a,b) => b.length - a.length)[0];
                    DATA = JSON.parse(cleanJson);
                    renderSidebar();
                    alert("‚úÖ FICHIER R√âPAR√â ET CHARG√â AVEC SUCC√àS !");
                } catch (err) {
                    alert("‚ö†Ô∏è Erreur : Le fichier est trop endommag√©.");
                }
            } else {
                alert("‚ùå Impossible de trouver les donn√©es dans ce fichier.");
            }
        };
        reader.readAsText(input.files[0]);
    }

    // --- 4. FONCTION DE SAUVEGARDE (G√©n√®re un fichier autonome) ---
    function sauvegarder() {
        const jsonStr = JSON.stringify(DATA);
        // On prend le code actuel de la page pour cr√©er le clone
        let htmlContent = document.documentElement.outerHTML;
        
        // On remplace la simulation par les vraies donn√©es pour que le fichier soit sauvegard√© rempli
        htmlContent = htmlContent.replace('initSimulation();', '// Simulation d√©sactiv√©e');
        htmlContent = htmlContent.replace('let DATA = {};', `let DATA = ${jsonStr};`);
        
        // On force le lancement de l'affichage au d√©marrage du nouveau fichier
        htmlContent = htmlContent.replace('</script>', 'renderSidebar(); </script>');

        const blob = new Blob([htmlContent], {type: 'text/html'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'RAPPORT_VAL_DE_MARNE_V92.html';
        a.click();
    }

    // Lancement au d√©marrage
    initSimulation();

</script>
</body>
</html>
