<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio CCAS | Performance</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --blue: #0A1A3C; --gold: #CCA43B; --bg: #f4f7fa; --red: #c0392b; --green: #27ae60; --font: 'Segoe UI', sans-serif; }
        body { font-family: var(--font); margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        * { box-sizing: border-box; outline: none; }
        .hidden { display: none !important; }
        
        /* SCROLLBAR MODERNE (Pour que ce soit joli dans le texte) */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold); }

        /* BOUTONS & UI */
        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-size: 14px; transition: 0.2s; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-gold { background: var(--gold); color: var(--blue); }
        .btn-blue { background: var(--blue); color: white; }
        .btn-green { background: var(--green); color: white; }
        .btn-red { background: white; color: var(--red); border: 1px solid var(--red); }
        .btn-ghost { background: transparent; border: 1px solid var(--gold); color: var(--gold); }
        .btn-simu { background: #333; color: #fff; border: 1px dashed #fff; } /* Bouton test */

        /* HEADER */
        header { height: 70px; background: var(--blue); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; color: white; border-bottom: 4px solid var(--gold); flex-shrink: 0; }
        .logo-img { height: 50px; background: white; padding: 2px; border-radius: 4px; display:none; }

        /* DASHBOARD */
        #dashboard { flex: 1; overflow-y: auto; display: flex; flex-direction: column; align-items: center; padding: 40px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 30px; width: 100%; max-width: 1200px; margin-top: 30px; }
        .project-card { background: white; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; position: relative; border: 2px solid transparent; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.2s; }
        .project-card:hover { border-color: var(--gold); transform: translateY(-5px); }
        .del-proj { position: absolute; top: 10px; right: 10px; color: var(--red); font-weight: bold; cursor: pointer; padding: 5px; }

        /* STUDIO */
        #studio { display: none; flex: 1; height: calc(100vh - 70px); }
        .sidebar { width: 300px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .bat-list { flex: 1; overflow-y: auto; padding: 10px; background: #f8f9fa; }
        .bat-item { padding: 12px; margin-bottom: 8px; background: white; border: 1px solid #eee; border-radius: 6px; cursor: pointer; display: flex; gap: 10px; transition: 0.2s; }
        .bat-item:hover { background: #fffdf5; border-color: var(--gold); }
        .bat-item.active { background: var(--gold); color: var(--blue); font-weight: bold; border-color: var(--gold); }
        
        .main-editor { flex: 1; display: flex; flex-direction: column; background: #eef2f6; overflow: hidden; }
        .editor-toolbar { height: 60px; background: white; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; flex-shrink: 0; }
        
        /* --- LAYOUT VERROUILL√â (CRITIQUE) --- */
        .content-area { flex: 1; overflow-y: auto; padding: 40px; display: flex; flex-direction: column; align-items: center; gap: 30px; }
        
        .block { 
            width: 100%; max-width: 950px; 
            height: 280px; /* HAUTEUR STRICTE */
            flex-shrink: 0; /* INTERDICTION DE R√âTR√âCIR */
            background: white; border-radius: 8px; display: flex; overflow: hidden; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: relative; border: 1px solid #ddd;
        }

        .block-img-area { 
            width: 350px; /* LARGEUR STRICTE */
            height: 100%;
            background: #111; 
            display: flex; align-items: center; justify-content: center; 
            position: relative; flex-shrink: 0;
        }
        .block-img-area img { width: 100%; height: 100%; object-fit: contain; }
        
        .block-txt-area { 
            flex: 1; display: flex; flex-direction: column; 
            border-left: 1px solid #eee; padding: 0; height: 100%; overflow: hidden; min-width: 0; 
        }
        .txt-tools { display: flex; gap: 5px; padding: 8px; border-bottom: 1px solid #eee; background: #fdfdfd; flex-shrink: 0; }
        .txt-btn { background: #fff; border: 1px solid #ccc; cursor: pointer; border-radius: 3px; font-weight: bold; font-size: 13px; padding: 4px 8px; }
        
        /* Zone de texte scrollable */
        .rich-editor { 
            flex: 1; 
            overflow-y: auto; /* C'est ici que la magie op√®re : si trop de texte, √ßa scroll */
            font-size: 0.95rem; line-height: 1.5; padding: 15px; outline: none; color: #333;
        }
        .rich-editor:focus { background: #fffdf5; }

        /* Outils image */
        .block-tools { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; opacity: 0; transition: 0.2s; }
        .block-img-area:hover .block-tools { opacity: 1; }
        .tool-btn { background: rgba(0,0,0,0.7); color: white; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 4px; cursor: pointer; font-size: 18px; }

        /* PAINT MODAL */
        #paint-modal { position: fixed; inset: 0; background: rgba(10,26,60,0.98); z-index: 2000; display: none; flex-direction: column; }
        canvas { border: 2px solid #333; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
    </style>
</head>
<body>
    <input type="file" id="inp-import" class="hidden" accept=".json" onchange="importDB(this)">
    <input type="file" id="inp-photos" class="hidden" multiple accept="image/*" onchange="processPhotos(this)">
    <img src="Logo_Cr√©teil_Val_Marne.svg.png" id="sys-logo" style="display:none">
    
    <div id="toast" style="position:fixed; bottom:20px; right:20px; background:var(--green); color:white; padding:10px 20px; border-radius:30px; display:none; z-index:9999; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">‚úÖ Sauvegard√©</div>

    <header>
        <div class="logo-area" style="display:flex; align-items:center; gap:10px; font-weight:bold;">
            <img id="app-logo" class="logo-img" src="">
            <span style="font-size:1.2rem; letter-spacing: 1px;">STUDIO CCAS</span>
        </div>
    </header>

    <div id="dashboard">
        <h1 style="color:var(--blue); margin-bottom:10px;">Mes Dossiers</h1>
        
        <div style="display:flex; gap:10px; margin-bottom:30px;">
            <button class="btn btn-gold" onclick="createProj()">+ NOUVEAU DOSSIER</button>
            <button class="btn btn-simu" onclick="stressTest()">üõ†Ô∏è LANCER SIMULATION (200 PHOTOS)</button>
        </div>
        
        <div id="grid" class="grid"></div>
        
        <div style="margin-top:auto; padding-top:30px; border-top:1px solid #ddd; width:100%; text-align:center;">
            <button class="btn btn-ghost" onclick="exportBackup()">üíæ SAUVEGARDER TOUT (PC)</button>
            <button class="btn btn-ghost" onclick="document.getElementById('inp-import').click()">üìÇ RESTAURER</button>
        </div>
    </div>

    <div id="studio">
        <div class="sidebar">
            <div style="padding:20px; background:var(--blue); color:white; text-align:center;">
                <button class="btn btn-ghost" style="color:white; border-color:rgba(255,255,255,0.3); width:100%; margin-bottom:15px;" onclick="goHome()">‚¨ÖÔ∏è RETOUR ACCUEIL</button>
                <div style="font-size:0.8rem; opacity:0.7; text-transform: uppercase;">Projet en cours</div>
                <h3 id="lbl-proj" style="color:var(--gold); margin:5px 0 0 0; cursor:pointer;" onclick="renProj()">Nom du Projet</h3>
            </div>
            <div id="list-bat" class="bat-list"></div>
            <div style="padding:15px; border-top:1px solid #ddd;">
                <button class="btn btn-blue" style="width:100%" onclick="addBat()">+ AJOUTER RUBRIQUE</button>
            </div>
        </div>
        
        <div class="main-editor">
            <div class="editor-toolbar">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:1.5rem;">üìÇ</span>
                    <h2 id="lbl-bat" style="color:var(--blue); margin:0;">Rubrique</h2>
                </div>
                <div style="display:flex; gap:10px">
                    <button class="btn btn-gold" onclick="document.getElementById('inp-photos').click()">üì∑ AJOUTER PHOTOS</button>
                    <button class="btn btn-green" onclick="genZip()">üöÄ G√âN√âRER LE RAPPORT</button>
                </div>
            </div>
            <div id="area-content" class="content-area"></div>
        </div>
    </div>

    <div id="paint-modal">
        <div style="height:60px; display:flex; justify-content:space-between; align-items:center; padding:0 20px; background:black; color:var(--gold);">
            <b>‚úèÔ∏è MODE RETOUCHE</b>
            <div><button class="btn btn-green" onclick="savePaint()">OK</button> <button class="btn btn-red" onclick="closePaint()">ANNULER</button></div>
        </div>
        <div style="flex:1; display:flex; justify-content:center; align-items:center; background:#111;"><canvas id="cvs"></canvas></div>
        <div style="height:80px; background:#111; display:flex; justify-content:center; align-items:center; gap:15px;">
            <button class="btn btn-ghost" onclick="pTool='rect'">‚¨ú</button>
            <button class="btn btn-ghost" onclick="pTool='circle'">‚≠ï</button>
            <button class="btn btn-ghost" onclick="pTool='arrow'">‚ÜóÔ∏è</button>
            <button class="btn btn-ghost" onclick="pTool='free'">‚úèÔ∏è</button>
            <input type="color" id="p-col" value="#ff0000">
            <input type="range" id="p-siz" min="2" max="20" value="5">
        </div>
    </div>

<script>
const DB_N="CCAS_V94_PERF", DB_V=1; let db, cP=null, cB=null, app={projects:{}, sets:{logo:null}};
window.onload=async()=>{ await iDB(); await lLogo(); rDash(); };

// --- 1. CORE & DB ---
function iDB(){ return new Promise(r=>{ const q=indexedDB.open(DB_N,DB_V); q.onupgradeneeded=e=>{e.target.result.createObjectStore('s',{keyPath:'id'})}; q.onsuccess=e=>{db=e.target.result; lData().then(r)}; q.onerror=()=>alert("Erreur DB"); }); }
function lData(){ return new Promise(r=>{ db.transaction('s').objectStore('s').get('d').onsuccess=e=>{if(e.target.result)app=e.target.result.v; r()}; }); }
function sData(){ db.transaction('s','readwrite').objectStore('s').put({id:'d',v:app}); const t=document.getElementById('toast'); t.style.display='block'; setTimeout(()=>t.style.display='none',1500); }

// --- 2. LOGO ---
function lLogo(){ return new Promise(r=>{ const i=document.getElementById('sys-logo'); if(app.sets.logo){uL();r();return;} if(i.complete&&i.naturalWidth){c64(i,b=>{app.sets.logo=b;sData();uL();r()})}else{i.onload=()=>{c64(i,b=>{app.sets.logo=b;sData();uL();r()})};i.onerror=()=>{console.log("No logo");r()}} }); }
function uL(){ const l=document.getElementById('app-logo'); if(app.sets.logo){l.src=app.sets.logo;l.style.display='block'} }
function c64(i,cb){ const c=document.createElement('canvas'); c.width=i.naturalWidth; c.height=i.naturalHeight; c.getContext('2d').drawImage(i,0,0); cb(c.toDataURL()); }

// --- 3. DASHBOARD ---
function rDash(){ 
    document.getElementById('dashboard').style.display='flex'; document.getElementById('studio').style.display='none';
    const g=document.getElementById('grid'); g.innerHTML='';
    Object.keys(app.projects).sort((a,b)=>app.projects[b].date-app.projects[a].date).forEach(k=>{
        const p=app.projects[k]; const d=document.createElement('div'); d.className='project-card';
        d.innerHTML=`<div class="del-proj" onclick="delP('${k}',event)">√ó</div><div style="font-size:3rem;margin-bottom:10px">üìÅ</div><b>${p.name}</b>`;
        d.onclick=()=>oProj(k); g.appendChild(d);
    });
}
function createProj(){ const n=prompt("Nom :"); if(n){ const id='p'+Date.now(); app.projects[id]={name:n,date:Date.now(),rubs:{'Accueil':[]},ord:['Accueil']}; sData(); rDash(); oProj(id); } }
function delP(id,e){ e.stopPropagation(); if(confirm("Supprimer ?")){ delete app.projects[id]; sData(); rDash(); } }
function exportBackup(){ const b=new Blob([JSON.stringify(app)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='CCAS_BACKUP.json'; a.click(); }
function importDB(i){ const f=i.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ if(confirm("Importer ?")){ const j=JSON.parse(e.target.result); app.projects={...app.projects,...j.projects}; sData(); rDash(); }}; r.readAsText(f); i.value=''; }

// --- 4. STUDIO ---
function oProj(id){ cP=id; document.getElementById('dashboard').style.display='none'; document.getElementById('studio').style.display='flex'; document.getElementById('lbl-proj').innerText=app.projects[id].name; if(!app.projects[id].ord)app.projects[id].ord=Object.keys(app.projects[id].rubs); const f=app.projects[id].ord[0]||''; if(f)oBat(f);else addBat(); rSide(); }
function renProj(){ const n=prompt("Nom:",app.projects[cP].name); if(n){app.projects[cP].name=n;document.getElementById('lbl-proj').innerText=n;sData();} }
function goHome(){ cP=null; rDash(); }
function rSide(){ const l=document.getElementById('list-bat'); l.innerHTML=''; app.projects[cP].ord.forEach(k=>{ const d=document.createElement('div'); d.className='bat-item '+(cB===k?'active':''); d.innerHTML=`<span style="flex:1">${k}</span><span onclick="delBat('${k}',event)" style="color:red;font-weight:bold">√ó</span>`; d.onclick=()=>oBat(k); l.appendChild(d); }); }
function addBat(){ const n=prompt("Nom rubrique:"); if(n&&!app.projects[cP].rubs[n]){ app.projects[cP].rubs[n]=[]; app.projects[cP].ord.push(n); sData(); oBat(n); rSide(); } }
function delBat(k,e){ e.stopPropagation(); if(confirm("Supprimer ?")){ delete app.projects[cP].rubs[k]; app.projects[cP].ord=app.projects[cP].ord.filter(x=>x!==k); sData(); if(cB===k)cB=null; if(app.projects[cP].ord.length)oBat(app.projects[cP].ord[0]); else {cB=null;rCont();} rSide(); } }
function oBat(k){ cB=k; rSide(); rCont(); }

// --- 5. CONTENU & PHOTOS ---
function rCont(){ 
    const a=document.getElementById('area-content'); a.innerHTML=''; document.getElementById('lbl-bat').innerText=cB||"-";
    if(!cB)return; const phs=app.projects[cP].rubs[cB];
    if(!phs.length){ a.innerHTML='<div style="text-align:center;color:#999;margin-top:50px">Dossier vide. Ajoutez des photos.</div>'; return; }
    phs.forEach((p,i)=>{
        const b=document.createElement('div'); b.className='block';
        b.innerHTML=`<div class="block-img-area"><img src="${p.src}"><div class="block-tools"><div class="tool-btn" onclick="paint(${i})">‚úèÔ∏è</div><div class="tool-btn" style="background:#c0392b" onclick="delPh(${i})">üóëÔ∏è</div></div></div>
        <div class="block-txt-area"><div class="txt-tools"><button class="txt-btn" onmousedown="fmt('bold',event)">B</button><button class="txt-btn" onmousedown="fmt('italic',event)">I</button><button class="txt-btn" onmousedown="fmt('underline',event)">U</button><button class="txt-btn" onmousedown="fmt('insertUnorderedList',event)">‚Ä¢ Liste</button><button class="txt-btn" onmousedown="fmt('foreColor',event,'red')" style="color:red">A</button></div>
        <div class="rich-editor" contenteditable="true" oninput="upTxt(${i},this.innerHTML)">${p.txt||''}</div></div>`;
        a.appendChild(b);
    });
}
function processPhotos(i){ const fs=Array.from(i.files); let cnt=0; if(!cB)return; document.getElementById('toast').innerText="‚è≥ Chargement..."; document.getElementById('toast').style.display='block';
    fs.forEach(f=>{ const r=new FileReader(); r.onload=e=>{ const im=new Image(); im.onload=()=>{
        const cv=document.createElement('canvas'); let w=im.width, h=im.height, m=1200; if(w>h){if(w>m){h*=m/w;w=m}}else{if(h>m){w*=m/h;h=m}} cv.width=w; cv.height=h; cv.getContext('2d').drawImage(im,0,0,w,h);
        app.projects[cP].rubs[cB].push({src:cv.toDataURL('image/jpeg',0.8),txt:"Observation..."}); cnt++; if(cnt===fs.length){sData(); rCont(); document.getElementById('toast').innerText="‚úÖ Termin√©";}
    }; im.src=e.target.result; }; r.readAsDataURL(f); }); i.value=''; }
function delPh(i){ if(confirm("Supprimer ?")){ app.projects[cP].rubs[cB].splice(i,1); sData(); rCont(); } }
let tm; function upTxt(i,h){ app.projects[cP].rubs[cB][i].txt=h; clearTimeout(tm); tm=setTimeout(sData,1000); }
function fmt(c,e,v=null){ e.preventDefault(); document.execCommand(c,false,v); }

// --- 6. SIMULATION CRASH TEST (LE CODE DEMAND√â) ---
function stressTest() {
    if(!confirm("‚ö†Ô∏è ATTENTION : Cela va cr√©er un projet 'TEST CHARGE' avec 200 photos et beaucoup de texte. Cela peut prendre 5 √† 10 secondes. Continuer ?")) return;
    
    const tEl = document.getElementById('toast');
    tEl.innerText = "‚è≥ G√©n√©ration des 200 photos..."; tEl.style.display = 'block';

    setTimeout(() => {
        const id = 'p_simu_' + Date.now();
        const newProj = { name: "TEST CHARGE LOURDE (200 Photos)", date: Date.now(), rubs: {}, ord: [] };
        
        // Cr√©ation d'une image placeholder l√©g√®re
        const cv = document.createElement('canvas'); cv.width=350; cv.height=250; 
        const ctx = cv.getContext('2d');
        ctx.fillStyle = "#eee"; ctx.fillRect(0,0,350,250);
        ctx.fillStyle = "#CCA43B"; ctx.font = "bold 30px Arial"; ctx.fillText("SIMULATION", 80, 130);
        const dummyImg = cv.toDataURL('image/jpeg', 0.6);

        // Texte long (7 lignes minimum)
        const longText = `
            <div><b>1. √âtat g√©n√©ral :</b> Constat d'usure normale.</div>
            <div><b>2. Plafonds :</b> Quelques traces d'humidit√© visibles.</div>
            <div><b>3. Sols :</b> Le rev√™tement est √† changer dans les 2 ans.</div>
            <div><b>4. √âlectricit√© :</b> Mise aux normes n√©cessaire (Tableau B).</div>
            <div><b>5. Plomberie :</b> Fuite l√©g√®re d√©tect√©e sous l'√©vier.</div>
            <div><b>6. Menuiserie :</b> Fen√™tre gauche ferme mal.</div>
            <div><b>7. Conclusion :</b> Travaux √† pr√©voir budget 2026.</div>
            <div style="color:red">Note urgente : V√©rifier l'acc√®s pompier.</div>
        `;

        // Boucle 25 B√¢timents x 8 Photos = 200 Photos
        for(let i=1; i<=25; i++) {
            const batName = "B√¢timent " + i;
            newProj.ord.push(batName);
            newProj.rubs[batName] = [];
            for(let j=1; j<=8; j++) {
                newProj.rubs[batName].push({
                    src: dummyImg,
                    txt: longText
                });
            }
        }

        app.projects[id] = newProj;
        sData();
        rDash();
        alert("‚úÖ Simulation termin√©e ! Ouvre le dossier 'TEST CHARGE LOURDE' pour v√©rifier la mise en page.");
    }, 100);
}

// --- 7. PAINT & ZIP ---
let pIdx, cvs, ctxPaint, pImg, isD=false, pTool='rect', sX, sY;
function paint(i){ pIdx=i; document.getElementById('paint-modal').style.display='flex'; cvs=document.getElementById('cvs'); ctxPaint=cvs.getContext('2d'); pImg=new Image(); pImg.onload=()=>{const mw=window.innerWidth*0.95, mh=window.innerHeight*0.8; let w=pImg.width, h=pImg.height, r=Math.min(mw/w, mh/h); cvs.width=w; cvs.height=h; cvs.style.width=(w*r)+'px'; cvs.style.height=(h*r)+'px'; ctxPaint.drawImage(pImg,0,0);}; pImg.src=app.projects[cP].rubs[cB][i].src; cvs.onmousedown=sd; cvs.onmousemove=dd; cvs.onmouseup=ed; cvs.ontouchstart=e=>{e.clientX=e.touches[0].clientX;e.clientY=e.touches[0].clientY;sd(e)}; cvs.ontouchmove=e=>{e.preventDefault();e.clientX=e.touches[0].clientX;e.clientY=e.touches[0].clientY;dd(e)}; cvs.ontouchend=ed; }
function gp(e){ const r=cvs.getBoundingClientRect(); return {x:(e.clientX-r.left)*(cvs.width/r.width), y:(e.clientY-r.top)*(cvs.height/r.height)}; }
function sd(e){ isD=true; const p=gp(e); sX=p.x; sY=p.y; ctxPaint.beginPath(); ctxPaint.strokeStyle=document.getElementById('p-col').value; ctxPaint.lineWidth=document.getElementById('p-siz').value; if(pTool==='free')ctxPaint.moveTo(sX,sY); }
function dd(e){ if(!isD)return; const p=gp(e); if(pTool==='free'){ctxPaint.lineTo(p.x,p.y); ctxPaint.stroke();} }
function ed(e){ if(!isD)return; isD=false; const p=gp(e), w=p.x-sX, h=p.y-sY; ctxPaint.beginPath(); if(pTool==='rect')ctxPaint.strokeRect(sX,sY,w,h); else if(pTool==='circle'){ctxPaint.arc(sX,sY,Math.sqrt(w*w+h*h),0,2*Math.PI);ctxPaint.stroke();} else if(pTool==='arrow'){const a=Math.atan2(h,w),l=30; ctxPaint.moveTo(sX,sY); ctxPaint.lineTo(p.x,p.y); ctxPaint.lineTo(p.x-l*Math.cos(a-Math.PI/6),p.y-l*Math.sin(a-Math.PI/6)); ctxPaint.moveTo(p.x,p.y); ctxPaint.lineTo(p.x-l*Math.cos(a+Math.PI/6),p.y-l*Math.sin(a+Math.PI/6)); ctxPaint.stroke();} }
function savePaint(){ app.projects[cP].rubs[cB][pIdx].src=cvs.toDataURL('image/jpeg',0.9); sData(); rCont(); closePaint(); }
function closePaint(){ document.getElementById('paint-modal').style.display='none'; }
function genZip(){ const p=app.projects[cP], z=new JSZip(), l=app.sets.logo||"";
    const h=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${p.name}</title><style>body{margin:0;font-family:'Segoe UI',sans-serif;display:flex;height:100vh;background:#0A1A3C;color:#fff;overflow:hidden}#s{width:300px;background:rgba(0,0,0,0.3);border-right:4px solid #CCA43B;display:flex;flex-direction:column}.head{padding:20px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.1)}#m{flex:1;overflow-y:auto}button{display:block;width:100%;padding:15px 20px;background:none;border:none;color:#aaa;text-align:left;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.05);transition:0.2s}button:hover{background:rgba(255,255,255,0.05);color:white}button.act{color:#CCA43B;font-weight:bold;border-left:4px solid #CCA43B;background:rgba(204,164,59,0.1)}#v{flex:1;display:flex;flex-direction:column;position:relative}#f{flex:1;background:#000;display:flex;justify-content:center;align-items:center;position:relative}#f img{max-width:100%;max-height:100%;object-fit:contain}.nav-btn{position:absolute;top:50%;transform:translateY(-50%);font-size:30px;cursor:pointer;width:50px;height:50px;background:rgba(204,164,59,0.8);color:#000;border-radius:50%;display:flex;align-items:center;justify-content:center;z-index:10}.p{left:20px}.n{right:20px}#i{height:180px;background:#fff;color:#000;padding:20px 40px;overflow-y:auto;border-top:4px solid #CCA43B}#t{color:#CCA43B;margin:0 0 10px 0;text-transform:uppercase;font-weight:bold}</style></head><body><div id="s"><div class="head">${l?'<img src="'+l+'" style="height:50px"><br>':''}<b>${p.name}</b></div><div id="m"></div></div><div id="v"><div id="f"><div class="nav-btn p" onclick="mv(-1)">‚ùÆ</div><img id="img"><div class="nav-btn n" onclick="mv(1)">‚ùØ</div></div><div id="i"><div id="t"></div><div id="d"></div></div></div><script>const d=${JSON.stringify(p.rubs)}, o=${JSON.stringify(p.ord)}; let cB=o[0], cI=0; function r(){document.getElementById('m').innerHTML=o.map(k=>'<button onclick="c(\\''+k+'\\')" class="'+(k==cB?'act':'')+'">'+k+'</button>').join('');const ps=d[cB];if(!ps||!ps.length){document.getElementById('img').src='';document.getElementById('t').innerText=cB;document.getElementById('d').innerHTML='Vide';return}document.getElementById('img').src=ps[cI].src;document.getElementById('t').innerText=cB+' | '+(cI+1)+'/'+ps.length;document.getElementById('d').innerHTML=ps[cI].txt;}function c(k){cB=k;cI=0;r()}function mv(v){const ps=d[cB];if(ps){cI=(cI+v+ps.length)%ps.length;r()}}window.onload=r;document.addEventListener('keydown',e=>{if(e.key==="ArrowRight")mv(1);if(e.key==="ArrowLeft")mv(-1)});<\/script></body></html>`;
    z.file(p.name+".html",h); z.generateAsync({type:"blob"}).then(c=>{const a=document.createElement('a'); a.href=URL.createObjectURL(c); a.download=p.name+".zip"; a.click()}); }
</script>
</body>
</html>
