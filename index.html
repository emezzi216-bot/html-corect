<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√âCUP√âRATEUR CCAS ULTIME</title>
    <style>
        /* RESET & BASE */
        :root { --blue: #0A1A3C; --gold: #CCA43B; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { 
            background: var(--blue); color: white; padding: 15px 30px; 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 5px solid var(--gold); flex-shrink: 0;
        }
        h1 { margin: 0; font-size: 24px; font-weight: bold; text-transform: uppercase; }

        /* BOUTONS */
        .btn { padding: 12px 25px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.2s; color: white; }
        .btn-import { background: #e67e22; } /* Orange */
        .btn-import:hover { background: #d35400; }
        .btn-save { background: #27ae60; display: none; } /* Vert */
        .btn-save:hover { background: #219150; }

        /* ZONE PRINCIPALE */
        #workspace { flex: 1; display: flex; overflow: hidden; position: relative; }
        
        /* LISTE DES BATIMENTS (GAUCHE) */
        #sidebar { 
            width: 300px; background: white; border-right: 1px solid #ccc; 
            overflow-y: auto; flex-shrink: 0; display: none; 
        }
        .bat-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; font-weight: 500; color: var(--blue); }
        .bat-item:hover { background: #f9f9f9; }
        .bat-item.active { background: var(--gold); color: var(--blue); font-weight: bold; }

        /* ZONE D'AFFICHAGE (DROITE) */
        #viewer { 
            flex: 1; overflow-y: auto; padding: 40px; 
            display: none; flex-direction: column; gap: 30px; align-items: center; 
        }

        /* --- LE FORMAT V9.2 (Celui que tu veux) --- */
        .card {
            display: flex; flex-direction: row; /* COTE A COTE */
            width: 100%; max-width: 1400px;
            background: white; border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 2px solid #ddd;
            min-height: 400px; /* Hauteur forc√©e pour √™tre √† l'aise */
        }

        /* PHOTO A GAUCHE (Taille fixe) */
        .card-img {
            width: 450px; /* Largeur fixe : ne bouge pas */
            background: black;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            border-right: 4px solid var(--gold);
        }
        .card-img img { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* TEXTE A DROITE (Prend toute la place restante) */
        .card-txt {
            flex: 1; 
            padding: 30px;
            font-size: 22px; /* TEXTE GROS PAR DEFAUT */
            line-height: 1.5;
            color: #333;
            overflow-y: auto;
            background: white;
        }

        /* ECRAN D'ACCUEIL */
        #welcome { 
            position: absolute; inset: 0; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            color: #888; text-align: center;
        }
        
        /* LOADER */
        #loader {
            position: fixed; inset: 0; background: rgba(10,26,60,0.95);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            color: var(--gold); z-index: 9999;
        }
    </style>
</head>
<body>

<input type="file" id="fileInput" style="display:none" onchange="analyserFichier(this)">

<div id="loader"><h1>‚è≥ ANALYSE PROFONDE...</h1><p>Recherche des photos dans la m√©moire du fichier...</p></div>

<header>
    <h1>RECONSTRUCTEUR V9.2</h1>
    <div>
        <button class="btn btn-import" onclick="document.getElementById('fileInput').click()">üìÇ 1. IMPORTER LE FICHIER BUGG√â</button>
        <button class="btn btn-save" id="btnSave" onclick="telecharger()">üíæ 2. T√âL√âCHARGER LE RAPPORT PROPRE</button>
    </div>
</header>

<div id="workspace">
    <div id="welcome">
        <div style="font-size: 50px;">üóëÔ∏è ‚ûî ‚ú®</div>
        <h2>Importe ton fichier HTML cass√© ci-dessus.</h2>
        <p>Je vais extraire toutes les photos et reconstruire la mise en page V9.2.</p>
    </div>

    <div id="sidebar"></div>
    
    <div id="viewer"></div>
</div>

<script>
    let BDD = {}; // La base de donn√©es reconstruite

    function analyserFichier(input) {
        if (input.files.length === 0) return;
        document.getElementById('loader').style.display = 'flex';

        const reader = new FileReader();
        reader.onload = function(e) {
            const contenu = e.target.result;
            
            // 1. EXTRACTION BRUTALE (REGEX)
            // On cherche n'importe quoi qui ressemble √† une structure JSON de donn√©es
            // Le motif cherche : {"NomBatiment": [{"src":...
            const regex = /\{"[^"]+":\s*\[\{"src"/g;
            let match = contenu.match(regex);
            
            // Si le regex pr√©cis √©choue, on tente le regex large (tout ce qui est entre accolades)
            if (!match) {
                match = contenu.match(/\{"[\s\S]*"\}/g);
            }

            if (match) {
                try {
                    // On prend la plus longue cha√Æne trouv√©e (c'est forc√©ment la BDD)
                    let rawJson = match.sort((a,b) => b.length - a.length)[0];
                    
                    // Nettoyage si le fichier a √©t√© coup√©
                    const lastBrace = rawJson.lastIndexOf('}');
                    if (lastBrace !== -1) rawJson = rawJson.substring(0, lastBrace + 1);

                    BDD = JSON.parse(rawJson);
                    
                    // Si on est l√†, c'est gagn√©. On lance l'interface.
                    lancerInterface();
                    
                } catch (err) {
                    alert("J'ai trouv√© des donn√©es, mais elles sont corrompues. Essaie quand m√™me, je vais afficher ce que je peux.");
                    console.error(err);
                }
            } else {
                alert("Impossible de trouver des photos dans ce fichier. Le format est inconnu.");
                document.getElementById('loader').style.display = 'none';
            }
        };
        reader.readAsText(input.files[0]);
    }

    function lancerInterface() {
        document.getElementById('welcome').style.display = 'none';
        document.getElementById('sidebar').style.display = 'block';
        document.getElementById('viewer').style.display = 'flex';
        document.getElementById('btnSave').style.display = 'inline-block';
        document.getElementById('loader').style.display = 'none';

        const sidebar = document.getElementById('sidebar');
        sidebar.innerHTML = '<div style="padding:15px; font-weight:bold; color:#888;">B√ÇTIMENTS TROUV√âS :</div>';
        
        const bats = Object.keys(BDD);
        
        bats.forEach((bat, index) => {
            const div = document.createElement('div');
            div.className = 'bat-item';
            div.innerText = `üè¢ ${bat} (${BDD[bat].length})`;
            div.onclick = () => {
                document.querySelectorAll('.bat-item').forEach(b => b.classList.remove('active'));
                div.classList.add('active');
                afficherBatiment(bat);
            };
            sidebar.appendChild(div);
            if (index === 0) div.click(); // Ouvre le premier direct
        });
    }

    function afficherBatiment(nom) {
        const viewer = document.getElementById('viewer');
        viewer.innerHTML = `<h2 style="width:100%; border-bottom:2px solid #CCA43B; padding-bottom:10px;">Photos du : ${nom}</h2>`;
        
        BDD[nom].forEach(photo => {
            const card = document.createElement('div');
            card.className = 'card';
            
            // Structure V9.2
            card.innerHTML = `
                <div class="card-img">
                    <img src="${photo.src}" loading="lazy">
                </div>
                <div class="card-txt" contenteditable="true">
                    ${photo.txt || "<em>(Clique ici pour ajouter une description)</em>"}
                </div>
            `;
            
            // Sauvegarde automatique des modifs de texte dans la m√©moire
            card.querySelector('.card-txt').addEventListener('input', (e) => {
                photo.txt = e.target.innerHTML;
            });
            
            viewer.appendChild(card);
        });
    }

    function telecharger() {
        // G√âN√âRATION DU FICHIER FINAL PROPRE
        const jsonStr = JSON.stringify(BDD);
        const html = `<!DOCTYPE html>
<html lang="fr"><head><meta charset="UTF-8"><title>RAPPORT CCAS FINAL</title>
<style>
body{font-family:'Segoe UI',sans-serif;background:#0A1A3C;color:white;padding:20px;margin:0;}
.bat{margin-bottom:50px;}
.bat h1{color:#CCA43B;border-bottom:3px solid #CCA43B;padding-bottom:10px;}
.card{display:flex;background:white;color:black;margin-bottom:20px;border:4px solid #CCA43B;min-height:350px;}
.img{width:400px;background:black;display:flex;align-items:center;justify-content:center;}
.img img{max-width:100%;max-height:100%;object-fit:contain;}
.txt{flex:1;padding:30px;font-size:22px;line-height:1.5;}
</style></head><body>
<div id="content"></div>
<script>
const data = ${jsonStr};
const c = document.getElementById('content');
Object.keys(data).forEach(k => {
    const batDiv = document.createElement('div'); batDiv.className='bat';
    batDiv.innerHTML = '<h1>üè¢ '+k+'</h1>';
    data[k].forEach(p => {
        batDiv.innerHTML += '<div class="card"><div class="img"><img src="'+p.src+'"></div><div class="txt">'+(p.txt||'')+'</div></div>';
    });
    c.appendChild(batDiv);
});
<\/script></body></html>`;

        const blob = new Blob([html], {type: 'text/html'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'RAPPORT_CLEAN_V92.html';
        a.click();
    }
</script>
</body>
</html>
